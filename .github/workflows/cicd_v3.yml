name: snowflake-devops-demo_v2

on:
  push:
    branches:
      - main
    paths:
      - 'snowflake/**'
  workflow_dispatch:

jobs:
  deploy-snowflake-changes-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install certifi schemachange snowflake-connector-python
          export SSL_CERT_FILE=$(python -m certifi)
      - name: Print all environment variables
        env:
            SF_ACCOUNT: "KVKBROL-AJA98516"
            SF_USERNAME: "STRIVER"
            SF_PASSWORD: "MistyStriver@17"
            SF_ROLE: "ACCOUNTADMIN"
            SF_WAREHOUSE: "COMPUTE_WH"
            SF_DATABASE: "SNOWFLAKE_LEARNING_DB"
            SF_SCHEMA: "DEMO_STG"
        run: |
          echo "SF_ACCOUNT=[$SF_ACCOUNT]"
          echo "SF_USERNAME=[$SF_USERNAME]"
          echo "SF_PASSWORD=[$SF_PASSWORD]"
          echo "SF_ROLE=[$SF_ROLE]"
          echo "SF_WAREHOUSE=[$SF_WAREHOUSE]"
          echo "SF_DATABASE=[$SF_DATABASE]"
          echo "SF_SCHEMA=[$SF_SCHEMA]"

      # ---------------------------------------------------------
      # DEBUG BLOCK â€” SHOW FILES AND CONTENT (SAFE)
      # ---------------------------------------------------------
      - name: Schemachange Full Debug
        env:
          SF_ACCOUNT: "QCA99998"
          SF_USERNAME: "STRIVER"
          SF_PASSWORD: "MistyStriver@17"
          SF_ROLE: "ACCOUNTADMIN"
          SF_WAREHOUSE: "COMPUTE_WH"
          SF_DATABASE: "SNOWFLAKE_LEARNING_DB"
          SF_SCHEMA: "DEMO_STG"
        run: |
          echo "=== FILES FOUND ==="
          find $GITHUB_WORKSPACE/snowflake -maxdepth 3 -type f -print

          echo "=== CONTENT OF 001_sql.sql ==="
          sed -n '1,20p' $GITHUB_WORKSPACE/snowflake/changes/001_sql.sql | sed -n 'l'

          echo "=== RUNNING SCHEMACHANGE DEBUG MODE ==="
          schemachange \
           --root-folder $GITHUB_WORKSPACE/snowflake/changes \
           --connection-name default \
            -v

      # ---------------------------------------------------------
      # MAIN SCHEMACHANGE EXECUTION
      # ---------------------------------------------------------
      - name: Run schemachange
        env:
          SF_ACCOUNT: "QCA99998"
          SF_USERNAME: "STRIVER"
          SF_PASSWORD: "MistyStriver@17"
          SF_ROLE: "ACCOUNTADMIN"
          SF_WAREHOUSE: "COMPUTE_WH"
          SF_DATABASE: "SNOWFLAKE_LEARNING_DB"
          SF_SCHEMA: "DEMO_STG"
          SSL_CERT_FILE: ${{ env.SSL_CERT_FILE }}
        run: |
          schemachange \
            -f $GITHUB_WORKSPACE/snowflake/changes \
            -a $SF_ACCOUNT \
            -u $SF_USERNAME \
            -p $SF_PASSWORD \
            -r $SF_ROLE \
            -w $SF_WAREHOUSE \
            -d $SF_DATABASE \
            -s $SF_SCHEMA \
            --create-change-history-table
